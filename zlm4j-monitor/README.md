# ZLM4J Monitor

ZLM4J Monitor æ˜¯ ZLMediaKit çš„ Java ç›‘æ§æ¨¡å—ï¼Œæä¾›ç³»ç»Ÿèµ„æºã€æµåª’ä½“ã€ç½‘ç»œçŠ¶æ€ç­‰å¤šç»´åº¦ç›‘æ§èƒ½åŠ›ã€‚åŸºäº ZLM4J å¼€å‘ï¼Œæ”¯æŒé…ç½®çƒ­åŠ è½½ã€æŒ‡æ ‡è‡ªå®šä¹‰ã€æ•°æ®å¯¼å‡ºç­‰ç‰¹æ€§ã€‚

## ç›®å½•
1. [é¡¹ç›®ä»‹ç»](#é¡¹ç›®ä»‹ç»)
2. [åŠŸèƒ½ç‰¹æ€§](#åŠŸèƒ½ç‰¹æ€§)
3. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
4. [è°ƒç”¨æµç¨‹](#è°ƒç”¨æµç¨‹)
5. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
6. [æŠ€æœ¯å®ç°](#æŠ€æœ¯å®ç°)
7. [é¡¹ç›®è¿›åº¦](#é¡¹ç›®è¿›åº¦)
8. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
9. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
10. [å‚ä¸è´¡çŒ®](#å‚ä¸è´¡çŒ®)

## é¡¹ç›®ä»‹ç»

ZLM4J Monitor æ˜¯ä¸€ä¸ªä¸“é—¨ä¸º ZLMediaKit è®¾è®¡çš„ç›‘æ§æ¨¡å—ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š
- è½»é‡çº§ï¼šä½èµ„æºå ç”¨ï¼Œå¯¹ä¸šåŠ¡æ— ä¾µå…¥
- å¯æ‰©å±•ï¼šæ”¯æŒè‡ªå®šä¹‰æŒ‡æ ‡å’Œå¯¼å‡ºå™¨
- é«˜æ€§èƒ½ï¼šå¼‚æ­¥å¤„ç†ï¼Œå¯¹è±¡æ± å¤ç”¨
- æ˜“ä½¿ç”¨ï¼šé…ç½®ç®€å•ï¼Œæ¥å…¥æ–¹ä¾¿

## åŠŸèƒ½ç‰¹æ€§

### 1. å¤šç»´åº¦ç›‘æ§
- **ç³»ç»Ÿç›‘æ§**
  - CPUã€å†…å­˜ã€ç£ç›˜ä½¿ç”¨ç‡
  - è¿›ç¨‹çŠ¶æ€
  - JVMè¿è¡ŒçŠ¶æ€
- **æµåª’ä½“ç›‘æ§**
  - åœ¨çº¿æµç»Ÿè®¡
  - æ¨æ‹‰æµçŠ¶æ€
  - ç¼–è§£ç ä¿¡æ¯
  - æµé‡ç»Ÿè®¡
- **ç½‘ç»œç›‘æ§**
  - è¿æ¥æ•°ç»Ÿè®¡
  - åè®®åˆ†å¸ƒ
  - å¸¦å®½ä½¿ç”¨
  - å»¶è¿Ÿç»Ÿè®¡

### 2. å¯æ‰©å±•æ€§
- SPIæ‰©å±•æœºåˆ¶
- è‡ªå®šä¹‰æŒ‡æ ‡æ”¶é›†
- è‡ªå®šä¹‰æ•°æ®å¯¼å‡º
- é…ç½®çƒ­åŠ è½½

### 3. é«˜æ€§èƒ½
- å¯¹è±¡æ± å¤ç”¨
- å¼‚æ­¥å¤„ç†
- æ‰¹é‡å¯¼å‡º
- èµ„æºéš”ç¦»

## æ¶æ„è®¾è®¡

### 1. ç³»ç»Ÿæ¶æ„
```
+------------------+     +-----------------+     +------------------+
|    ZLM Server    |     |   ZLM4J Core   |     |   ZLM Monitor   |
|                  +---->|                 +---->|                 |
| (Media Server)   |     | (API Wrapper)   |     | (Monitor Core)  |
+------------------+     +-----------------+     +--------+--------+
                                                         |
                                                         v
                              +-------------------------------------------------------------------------+
                              |                       Collectors                                       |
                              |  +---------------+  +---------------+  +---------------+  +---------+  |
                              |  |    System     |  |    Stream     |  |    Network    |  |   ...  |  |
                              |  |   Collector   |  |   Collector   |  |   Collector   |  |        |  |
                              |  +---------------+  +---------------+  +---------------+  +---------+  |
                              +-------------------------------------------------------------------------+
                                                         |
                                                         v
                              +-------------------------------------------------------------------------+
                              |                       Exporters                                       |
                              |  +---------------+  +---------------+  +---------------+  +---------+  |
                              |  |    Console    |  |  Prometheus   |  |   InfluxDB    |  |   ...  |  |
                              |  |   Exporter    |  |   Exporter    |  |   Exporter    |  |        |  |
                              |  +---------------+  +---------------+  +---------------+  +---------+  |
                              +-------------------------------------------------------------------------+
```

### 2. æ ¸å¿ƒç»„ä»¶
- **ZLMMonitor**: ç›‘æ§æ ¸å¿ƒï¼Œè´Ÿè´£ç”Ÿå‘½å‘¨æœŸç®¡ç†
- **Collectors**: æŒ‡æ ‡æ”¶é›†å™¨ï¼Œè´Ÿè´£æ•°æ®é‡‡é›†
- **Processors**: æ•°æ®å¤„ç†å™¨ï¼Œè´Ÿè´£æŒ‡æ ‡è½¬æ¢
- **Exporters**: æ•°æ®å¯¼å‡ºå™¨ï¼Œè´Ÿè´£æ•°æ®è¾“å‡º

## è°ƒç”¨æµç¨‹

### 1. åˆå§‹åŒ–æµç¨‹
```
ç”¨æˆ·ä»£ç 
   â†“
ZLMMonitor.builder()
   â†“
ConfigManageråˆå§‹åŒ–
   - åŠ è½½é…ç½®æ–‡ä»¶
   - éªŒè¯é…ç½®
   - å¯ç”¨çƒ­åŠ è½½
   â†“
åˆå§‹åŒ–ç»„ä»¶
   - åˆ›å»ºçº¿ç¨‹æ± 
   - åˆå§‹åŒ–æ”¶é›†å™¨
   - åˆå§‹åŒ–å¯¼å‡ºå™¨
```

### 2. ç›‘æ§æµç¨‹
```
å®šæ—¶è°ƒåº¦çº¿ç¨‹                 å·¥ä½œçº¿ç¨‹æ± 
     â†“                         â†“
è§¦å‘æ”¶é›†ä»»åŠ¡              å¤„ç†æ”¶é›†ç»“æœ
     â†“                         â†“
Collectorsæ”¶é›†æ•°æ®    â†’    æ•°æ®éªŒè¯
     â†“                         â†“
æäº¤åˆ°å·¥ä½œçº¿ç¨‹æ±      â†    æŒ‡æ ‡è½¬æ¢
                              â†“
                         æ•°æ®èšåˆ
                              â†“
                         å¯¼å‡ºæ•°æ®
```

## å¿«é€Ÿå¼€å§‹

### 1. æ·»åŠ ä¾èµ–
```xml
<dependency>
    <groupId>com.aizuda</groupId>
    <artifactId>zlm4j-monitor</artifactId>
    <version>1.1.9</version>
</dependency>
```

### 2. åˆ›å»ºç›‘æ§å®ä¾‹
```java
// 1. åˆ›å»º ZLM API å®¢æˆ·ç«¯
ZLMConfig config = new ZLMConfig()
    .setHost("localhost")
    .setPort(8080)
    .setSecret("035c73f7-bb6b-4889-a715-d9eb2d1925cc");
    
ZLMApi zlmApi = new ZLMApi(config);

// 2. åˆ›å»ºç›‘æ§å™¨
ZLMMonitor monitor = ZLMMonitor.builder(zlmApi)
    .withConfigFile("monitor.yml")  // å¯é€‰ï¼šä½¿ç”¨é…ç½®æ–‡ä»¶
    .build();

// 3. æ·»åŠ ç›‘æ§å›è°ƒ
monitor.setCallback(new MonitorCallback() {
    @Override
    public void onSystemMetrics(SystemMetrics metrics) {
        System.out.printf("CPU: %.2f%%, Memory: %.2f%%\n", 
            metrics.getCpuUsage(), metrics.getMemoryUsage());
    }
});

// 4. å¯åŠ¨ç›‘æ§
monitor.start();
```

### 3. é…ç½®è¯´æ˜
```yaml
# monitor.yml
basic:
  sample-interval: 5000  # é‡‡æ ·é—´éš”(æ¯«ç§’)
  initial-delay: 0       # åˆå§‹å»¶è¿Ÿ(æ¯«ç§’)
  daemon: true          # æ˜¯å¦å®ˆæŠ¤çº¿ç¨‹

metrics:
  system:
    enabled: true      # ç³»ç»ŸæŒ‡æ ‡
  stream:
    enabled: true      # æµåª’ä½“æŒ‡æ ‡
  network:
    enabled: true      # ç½‘ç»œæŒ‡æ ‡
```

## æŠ€æœ¯å®ç°

### 1. æ ¸å¿ƒæŠ€æœ¯æ ˆ
- **åŸºç¡€æ¡†æ¶**: Java 8+
- **é…ç½®è§£æ**: Jackson YAML/JSON
- **ç³»ç»Ÿç›‘æ§**: OSHI
- **æ—¥å¿—æ¡†æ¶**: SLF4J + Logback
- **å¹¶å‘å¤„ç†**: JUC
- **æ‰©å±•æœºåˆ¶**: Java SPI

### 2. å…³é”®ç‰¹æ€§å®ç°

#### é…ç½®çƒ­åŠ è½½
```java
public class ConfigManager {
    private final FileWatcher fileWatcher;
    
    public void enableHotReload() {
        fileWatcher.startWatch();
        fileWatcher.addListener(event -> {
            if (event.kind() == ENTRY_MODIFY) {
                reloadConfig();
            }
        });
    }
}
```

#### å¯¹è±¡æ± å¤ç”¨
```java
public class ObjectPool<T> {
    private final ArrayBlockingQueue<T> pool;
    private final Supplier<T> factory;
    
    public T acquire() {
        T obj = pool.poll();
        return obj != null ? obj : factory.get();
    }
    
    public void release(T obj) {
        pool.offer(obj);
    }
}
## é¡¹ç›®è¿›åº¦

### å·²å®ŒæˆåŠŸèƒ½
- âœ… æ ¸å¿ƒç›‘æ§æ¡†æ¶
  - åŸºç¡€æ¶æ„è®¾è®¡
  - ç”Ÿå‘½å‘¨æœŸç®¡ç†
  - é…ç½®çƒ­åŠ è½½
  - çº¿ç¨‹æ± ç®¡ç†
  - èµ„æºéš”ç¦»

- âœ… æŒ‡æ ‡æ”¶é›†å™¨
  - ç³»ç»ŸæŒ‡æ ‡æ”¶é›†å™¨
  - æµåª’ä½“æŒ‡æ ‡æ”¶é›†å™¨
  - ç½‘ç»œæŒ‡æ ‡æ”¶é›†å™¨
  - æ€§èƒ½æŒ‡æ ‡æ”¶é›†å™¨

- âœ… å¯¼å‡ºæœºåˆ¶
  - SPIæ‰©å±•æœºåˆ¶
  - é»˜è®¤æ—¥å¿—å¯¼å‡ºå™¨
  - JSONæ–‡ä»¶å¯¼å‡ºå™¨
  - æ§åˆ¶å°å¯¼å‡ºå™¨

### è¿›è¡Œä¸­
- ğŸš§ ç›‘æ§æ‰©å±•
  - Prometheuså¯¼å‡ºå™¨
  - InfluxDBå¯¼å‡ºå™¨
  - å‘Šè­¦æœºåˆ¶
  - æŒ‡æ ‡èšåˆ

- ğŸš§ æ€§èƒ½ä¼˜åŒ–
  - å¯¹è±¡æ± æœºåˆ¶
  - æ‰¹é‡å¤„ç†
  - GCä¼˜åŒ–
  - èµ„æºé™æµ

### è§„åˆ’ä¸­
- ğŸ“… å¯è§‚æµ‹æ€§å¢å¼º
  - é“¾è·¯è¿½è¸ª
  - æ—¥å¿—å®Œå–„
  - ç›‘æ§å¤§ç›˜
  - å‘Šè­¦è§„åˆ™

## æœ€ä½³å®è·µ

### 1. æ€§èƒ½ä¼˜åŒ–
- åˆç†è®¾ç½®é‡‡æ ·é—´éš”
  ```yaml
  basic:
    sample-interval: 5000  # ä¸€èˆ¬åœºæ™¯
    sample-interval: 1000  # é«˜ç²¾åº¦åœºæ™¯
    sample-interval: 30000 # èµ„æºå—é™åœºæ™¯
  ```

- å¯ç”¨å¯¹è±¡æ± 
  ```java
  // åˆ›å»ºå¯¹è±¡æ± 
  ObjectPool<StreamMetrics> pool = new ObjectPool<>(
      () -> new StreamMetrics(),
      metrics -> metrics.reset(),
      Runtime.getRuntime().availableProcessors() * 2
  );
  ```

### 2. é”™è¯¯å¤„ç†
```java
monitor.setCallback(new MonitorCallback() {
    @Override
    public void onError(Throwable error) {
        log.error("ç›‘æ§å¼‚å¸¸", error);
    }
});

// ä¼˜é›…å…³é—­
Runtime.getRuntime().addShutdownHook(new Thread(() -> {
    try {
        monitor.stop();
        monitor.close();
    } catch (Exception e) {
        log.error("å…³é—­å¤±è´¥", e);
    }
}));
```

### 3. é…ç½®å»ºè®®
- å¼€å‘ç¯å¢ƒ
  ```yaml
  basic:
    sample-interval: 1000
    daemon: false
  metrics:
    all-enabled: true
  exporter:
    names: [console, json]
  ```

- ç”Ÿäº§ç¯å¢ƒ
  ```yaml
  basic:
    sample-interval: 5000
    daemon: true
  metrics:
    system.enabled: true
    stream.enabled: true
    network.enabled: true
  exporter:
    names: [prometheus]
    batch-enabled: true
  ```

## å¸¸è§é—®é¢˜

### 1. æ€§èƒ½å½±å“
Q: ç›‘æ§ä¼šå½±å“ ZLM æœåŠ¡å™¨æ€§èƒ½å—ï¼Ÿ
A: é»˜è®¤é…ç½®ä¸‹å½±å“å¾ˆå°ï¼š
- CPU: < 1%
- å†…å­˜: < 50MB
- ç½‘ç»œ: å¯å¿½ç•¥

### 2. é…ç½®é—®é¢˜
Q: é…ç½®æ–‡ä»¶ä¿®æ”¹åä¸ç”Ÿæ•ˆï¼Ÿ
A: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
- é…ç½®æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®
- æ–‡ä»¶æ˜¯å¦æœ‰è¯»å–æƒé™
- é…ç½®æ ¼å¼æ˜¯å¦æ­£ç¡®
- æŸ¥çœ‹é”™è¯¯æ—¥å¿—

### 3. æ‰©å±•å¼€å‘
Q: å¦‚ä½•å¼€å‘è‡ªå®šä¹‰å¯¼å‡ºå™¨ï¼Ÿ
A: å®ç°ä»¥ä¸‹æ­¥éª¤ï¼š
1. å®ç° MetricsExporter æ¥å£
2. æ·»åŠ  @SPI æ³¨è§£
3. åˆ›å»º SPI é…ç½®æ–‡ä»¶
4. åœ¨é…ç½®ä¸­å¯ç”¨

## å‚ä¸è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ PRï¼š
- Bug ä¿®å¤
- åŠŸèƒ½æ”¹è¿›
- æ–‡æ¡£å®Œå–„
- æ€§èƒ½ä¼˜åŒ–

## è®¸å¯è¯

Apache License 2.0
